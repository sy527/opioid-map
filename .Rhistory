st_drop_geometry() %>%
filter(matched == "ARCOS_OPEN") %>%
mutate(
totalMME = rowSums(across(starts_with("totalMME_")), na.rm = TRUE),
totalgm = rowSums(across(starts_with("totalgm_")), na.rm = TRUE),
totalQ = rowSums(across(starts_with("totalQ_")), na.rm = TRUE)
)
# install.packages("usmap")
install.packages("gganimate")
library(gganimate)
library(usmap)
ymMME <- map %>%
st_drop_geometry() %>%
group_by(fips, ym) %>%
summarise(totalMME = sum(totalMME),
n_physician = n_distinct(npi),
.groups = "drop") %>%
mutate(totalMME = ifelse(is.na(totalMME), 0, totalMME),
MMEperphys = totalMME/n_physician)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = fipsMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
transition_time(ym)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
transition_time(ym)
cap <- quantile(ymMME$mmeperphys, .90, na.rm = TRUE)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
transition_time(ym)
anim <- animate(check, nframes=9, fps=1)
anim <- animate(anim, nframes=9, fps=1)
fips <- ymMME %>%
select(fips) %>%
distinct()
View(fips)
ymMME <- map %>%
st_drop_geometry() %>%
group_by(fips, ym) %>%
summarise(totalMME = sum(totalMME),
n_physician = n_distinct(npi),
.groups = "drop") %>%
mutate(totalMME = ifelse(is.na(totalMME), 0, totalMME),
MMEperphys = totalMME/n_physician) %>%
filter(fips != "")
View(fips)
# get all the fipscode from tidycensus
library(tidycensus)
fips <- tidycensus::fips_codes
View(fips)
fips <- fips %>%
mutate(fips = paste0(state_code, county_code))
View(fips)
fips <- fips %>%
mutate(fips = paste0(state_code, county_code)) %>%
select(fips)
# find the missing fipscodes
missingfips <- ymMME %>%
select(fips) %>% distinct() %>%
anti_join(fips, by = "fips")
View(missingfips)
# find the missing fipscodes
missingfips <- ymMME %>%
select(fips) %>% distinct()
View(missingfips)
missing <- missingfips %>%
anti_join(fips, by = "fips")
missing <- missingfips %>%
outer_join(fips, by = "fips")
missing <- fips %>%
anti_join(missingfips, by = "fips")
View(missing)
# find the missing fipscodes
missingfips <- fips %>%
anti_join(ymMME %>% select(fips) %>% distinct(), by = "fips")
# cross join: all missing fips × all ym
missing_expand <- missingfips %>%
crossing(all_ym) %>%
mutate(
totalMME = 0,
n_physician = 0,
MMEperphys = 0
)
# get all unique ym values
all_ym <- ymMME %>%
distinct(ym)
# cross join: all missing fips × all ym
missing_expand <- missingfips %>%
crossing(all_ym) %>%
mutate(
totalMME = 0,
n_physician = 0,
MMEperphys = 0
)
# append back into ymMME
ymMME <- bind_rows(ymMME, missing_expand) %>%
group_by(fips, ym) %>%
summarise(totalMME = sum(totalMME),
n_physician = sum = n_physician,
# append back into ymMME
ymMME <- bind_rows(ymMME, missing_expand) %>%
group_by(fips, ym) %>%
summarise(totalMME = sum(totalMME),
n_physician = sum(n_physician),
MMEperphys = sum(MMEperphys),
.groups = "drop") %>%
mutate(totalMME = ifelse(is.na(totalMME), 0, totalMME),
MMEperphys = totalMME/n_physician) %>%
filter(fips != "")
# append back into ymMME
ymMME <- bind_rows(ymMME, missing_expand) %>%
group_by(fips, ym) %>%
summarise(totalMME = sum(totalMME),
n_physician = sum(n_physician),
MMEperphys = sum(MMEperphys),
.groups = "drop") %>%
mutate(totalMME = ifelse(is.na(totalMME), 0, totalMME),
MMEperphys = totalMME/n_physician) %>%
filter(fips != "")
cap <- quantile(ymMME$mmeperphys, .90, na.rm = TRUE)
cap <- quantile(ymMME$MMEperphys, .90, na.rm = TRUE)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
transition_time(ym)
anim <- animate(anim, nframes=9, fps=1)
anim
cap <- quantile(ymMME$MMEperphys, .99, na.rm = TRUE)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = "MME Purchase Per Physician by Year-Month: {frame_time}")
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = "MME Purchase Per Physician by Year-Month: {frame_time}") %>%
transition_time(ym)
anim <- animate(anim, nframes=9, fps=1)
anim
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'MME Purchase Per Physician by Year-Month: {frame_time}') +
transition_time(ym)
anim <- animate(anim, nframes=9, fps=1)
anim
anim_save("output/mmePurchasePhysician.gif")
ymPay <- map %>%
st_drop_geometry() %>%
group_by(fips, ym) %>%
summarise(totalPay = sum(total.payment),
n_physician = n_distinct(npi),
.groups = "drop") %>%
mutate(totalPay = ifelse(is.na(totalPay), 0, totalMME),
PAYperphys = totalPay/n_physician) %>%
filter(fips != "")
ymPay <- map %>%
st_drop_geometry() %>%
group_by(fips, ym) %>%
summarise(totalPay = sum(total.payment),
n_physician = n_distinct(npi),
.groups = "drop") %>%
mutate(totalPay = ifelse(is.na(totalPay), 0, totalPay),
PAYperphys = totalPay/n_physician) %>%
filter(fips != "")
# find the missing fipscodes
missingfips <- fips %>%
anti_join(ymPay %>% select(fips) %>% distinct(), by = "fips")
# get all unique ym values
all_ym <- ymPay %>%
distinct(ym)
# cross join: all missing fips × all ym
missing_expand <- missingfips %>%
crossing(all_ym) %>%
mutate(
totalPay = 0,
n_physician = 0,
PAYperphys = 0
)
# append back into ymMME
ymPay <- bind_rows(ymPay, missing_expand) %>%
group_by(fips, ym) %>%
summarise(totalPay = sum(totalPay),
n_physician = sum(n_physician),
PAYperphys = sum(PAYperphys),
.groups = "drop") %>%
mutate(totalPay = ifelse(is.na(totalPay), 0, totalPay),
PAYperphys = totalPay/n_physician) %>%
filter(fips != "")
cap <- quantile(ymPay$PAYperphys, .95, na.rm = TRUE)
animPay <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymPay,
values = "PAYperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "Payment Received Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'Payment Received Per Physician by Year-Month: {frame_time}') +
transition_time(ym)
animPay <- animate(animPay, nframes=9, fps=1)
animPay <- animate(animPay, nframes=9, fps=1)
animPay <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymPay,
values = "PAYperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "Payment Received Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'Payment Received Per Physician by Year-Month: {frame_time}') +
transition_time(ym)
animPay <- animate(animPay, nframes=9, fps=1)
anim <- animate(anim, nframes=9, fps=1)
animPay <- animate(animPay, nframes=9, fps=1)
animPay
cap <- quantile(ymMME$MMEperphys, .98, na.rm = TRUE)
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'MME Purchase Per Physician by Year-Month: {frame_time}') +
transition_time(ym) +
shadow_wake(wake_length = 0.1, alpha = TRUE, falloff = "linear")
anim <- animate(anim, nframes=1, fps=1, height = 800, width = 800)
anim <- animate(anim, nframes=3, fps=1, height = 800, width = 800)
anim
frame <- ymMME %>%
select(ym) %>%
distinct()
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'MME Purchase Per Physician by Year-Month: {frame_time}') +
transition_time(ym) +
shadow_wake(wake_length = 0.1, alpha = TRUE, falloff = "linear")
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'MME Purchase Per Physician by Year-Month: {frame_time}') +
transition_time(ym) +
shadow_wake(wake_length = 0.1, alpha = TRUE, falloff = "linear")
anim <- animate(anim, nframes=72, fps=0.7, height = 800, width = 800)
anim <- animate(anim, nframes=72, fps=1, height = 800, width = 800)
anim
anim_save("output/mmePurchasePhysician.gif")
animPay <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymPay,
values = "PAYperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "Payment Received Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'Payment Received Per Physician by Year-Month: {frame_time}') +
transition_time(ym)
animPay
animPay <- animate(animPay, width = 800, height = 800, res = 150)
animPay
anim_save("output/perPaymentPhysician.gif")
anim <- plot_usmap(
color = "white",
linewidth = 0.1,
regions = "counties",
data = ymMME,
values = "MMEperphys"
) +
scale_fill_gradientn(
colors = c("lightblue", "skyblue", "orange", "red", "darkred"),
limits = c(0, cap),
oob = scales::squish,
labels = scales::label_number(scale_cut = scales::cut_short_scale()),
name = "MME Per Physician"
) +
theme(legend.position = 'right') +
labs(title = 'MME Purchase Per Physician by Year-Month: {frame_time}') +
transition_time(ym) +
shadow_wake(wake_length = 0.1, alpha = TRUE, falloff = "linear")
anim <- animate(anim, height = 800, width = 800, res = 150)
anim
anim_save("output/mmePurchasePhysician.gif")
rmarkdown::render_site()
setwd("I:/Research/sunyoon/research/programs/analysis/APPAM/map/")
rmarkdown::render_site()
rmarkdown::render_site()
getwd()
rmarkdown::render("Aim 1 MapsGganimate_APPAM.Rmd")
rmarkdown::render("/Aim 1 MapsGganimate_APPAM.Rmd")
rmarkdown::render("/Aim 1 MapsGganimate_APPAM.Rmd")
rmarkdown::render("I:/Research/sunyoon/research/programs/analysis/APPAM/map/Aim 1 MapsGganimate_APPAM.Rmd")
getAnywhere(render)
# 0) Absolute path
path <- "I:/Research/sunyoon/research/programs/analysis/APPAM/map/Aim 1 MapsGganimate_APPAM.Rmd"
# 1) Sanity checks
file.exists(path)                     # should be TRUE
tools::file_path_as_absolute(path)    # prints normalized absolute path
# 2) Call the real function explicitly from the namespace
get("render", asNamespace("rmarkdown"))(
input    = path,
encoding = "UTF-8",
clean    = TRUE,
envir    = new.env()    # clean knit environment
)
# A) Make sure rmarkdown is current
packageVersion("rmarkdown")
# B) Temporarily detach evaluate (rarely needed, but just in case)
detach("package:evaluate", unload = TRUE)
library(rmarkdown)
get("render", asNamespace("rmarkdown"))(input = path, encoding = "UTF-8", clean = TRUE, envir = new.env())
# 1) Restart R (Ctrl+Shift+F10 in RStudio)
# 2) Minimal proof that rmarkdown::render works
library(rmarkdown)
example_rmd <- system.file("rmarkdown", "templates", "html_vignette",
"resources", "vignette.Rmd", package = "rmarkdown")
stopifnot(file.exists(example_rmd))
rmarkdown::render(example_rmd)  # should create vignette.html in your wd
# 2) Minimal proof that rmarkdown::render works
library(rmarkdown)
example_rmd <- system.file("rmarkdown", "templates", "html_vignette",
"resources", "vignette.Rmd", package = "rmarkdown")
stopifnot(file.exists(example_rmd))
rmarkdown::render(example_rmd)  # should create vignette.html in your wd
install.packages(c("rmarkdown","evaluate","knitr"))
rmarkdown::render(tmp_rmd)     # should create test_render.html in tempdir()
tools::file_path_as_absolute(path)
path <- "I:/Research/sunyoon/research/programs/analysis/APPAM/map/Aim 1 MapsGganimate_APPAM.Rmd"
file.exists(path)  # must be TRUE
tools::file_path_as_absolute(path)
library(rmarkdown)
# library(rmarkdown)
rmarkdown::render(input = path, encoding = "UTF-8", clean = TRUE, envir = new.env())
setwd("I:/Research/sunyoon/research/programs/analysis/APPAM/map")
file.copy("Aim 1 MapsGganimate_APPAM.Rmd", "aim1_maps.Rmd", overwrite = TRUE)
suppressWarnings(detach("package:evaluate", unload = TRUE))
suppressWarnings(detach("package:gganimate", unload = TRUE))
rm(list = ls()[ls() %in% c("render")])
library(rmarkdown)
rmarkdown::render("aim1_maps.Rmd", encoding = "UTF-8", clean = TRUE, envir = new.env())
traceback()
print(rmarkdown::render)
formals(rmarkdown::render)
sessionInfo()
rmarkdown::render("aim1_maps.Rmd", encoding = "UTF-8", clean = TRUE, envir = new.env())
render_site()
rmarkdown::render("aim1_maps.Rmd", encoding = "UTF-8", clean = TRUE, envir = new.env())
rmarkdown::render("aim1_maps.Rmd",
output_format = distill::distill_article(),
encoding = "UTF-8",
clean = TRUE,
envir = new.env())
rmarkdown::render("aim1_maps.Rmd",
output_format = distill::distill_article(),
encoding = "UTF-8",
clean = TRUE,
envir = new.env())
rmarkdown::render("aim1_maps.Rmd",
output_format = distill::distill_article(),
encoding = "UTF-8",
clean = TRUE,
envir = new.env())
rmarkdown::render("aim1_maps.Rmd",
output_format = distill::distill_article(),
encoding = "UTF-8",
clean = TRUE,
envir = new.env())
rmarkdown::render("aim1_maps.Rmd",
output_format = distill::distill_article(),
encoding = "UTF-8",
clean = TRUE,
envir = new.env())
